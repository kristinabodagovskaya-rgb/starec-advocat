# Starec-Advocat 2.0 - Детальная архитектура проекта

**Дата создания:** 19 января 2026
**Версия:** 1.0
**Назначение:** Система анализа уголовных дел для адвокатов

---

## 1. ОБЩАЯ АРХИТЕКТУРА СИСТЕМЫ

```
┌─────────────────────────────────────────────────────────────────┐
│                         ПОЛЬЗОВАТЕЛЬ                             │
│                    (Адвокат, Юрист)                              │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                    CLOUDFLARE CDN + SSL                          │
│              advocat.starec.ai (Frontend)                        │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│         НЕМЕЦКИЙ СЕРВЕР HETZNER (136.243.71.213)                │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    FRONTEND (React SPA)                   │  │
│  │  - Vite + React 18                                        │  │
│  │  - Nginx (порт 80/443)                                    │  │
│  │  - advocat.starec.ai                                      │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                 BACKEND API (FastAPI)                     │  │
│  │  - FastAPI + Uvicorn                                      │  │
│  │  - Порт: 8083                                             │  │
│  │  - JWT аутентификация                                     │  │
│  │  - RESTful API                                            │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │            DOCUMENT PROCESSING SERVICE                    │  │
│  │  - Celery Workers (3 воркера)                            │  │
│  │  - OCR обработка (Tesseract/Cloud Vision API)           │  │
│  │  - PDF парсинг (PyMuPDF)                                 │  │
│  │  - Выделение документов (AI-анализ структуры)           │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              ANALYSIS SERVICE (AI)                        │  │
│  │  - Claude API (Opus 4.5) для анализа                    │  │
│  │  - OpenAI GPT-4 (резервный)                             │  │
│  │  - Vector embeddings (текстовый поиск)                   │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    БАЗЫ ДАННЫХ                            │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │  │
│  │  │ PostgreSQL   │  │   MongoDB    │  │    Redis     │   │  │
│  │  │ (основная БД)│  │  (документы) │  │ (очереди)    │   │  │
│  │  │ Порт: 5433   │  │ Порт: 27018  │  │ Порт: 6380   │   │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘   │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              ФАЙЛОВОЕ ХРАНИЛИЩЕ                           │  │
│  │  - Google Drive API (источник томов)                     │  │
│  │  - MinIO / S3-compatible storage (обработанные файлы)    │  │
│  │  - /var/data/starec-advocat/ (локальное хранение)       │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. ЭТАПЫ РАБОТЫ ПОЛЬЗОВАТЕЛЯ (USER FLOW)

### ЭТАП 1: РЕГИСТРАЦИЯ И ВХОД

**Экран: Страница входа**

```
┌─────────────────────────────────────────────────────────┐
│                   STAREC ADVOCAT                         │
│         Система анализа уголовных дел                    │
│                                                          │
│  ┌────────────────────────────────────────────────┐     │
│  │  Email:  [____________________________]        │     │
│  │  Пароль: [____________________________]        │     │
│  │                                                 │     │
│  │  [ Войти ]        [ Регистрация ]             │     │
│  │                                                 │     │
│  │  [ Забыли пароль? ]                           │     │
│  └────────────────────────────────────────────────┘     │
│                                                          │
│  Или войти через:                                       │
│  [ Google ] [ Яндекс ]                                  │
└─────────────────────────────────────────────────────────┘
```

**Функции:**
- 🔘 Кнопка "Войти" - вход по email/паролю
- 🔘 Кнопка "Регистрация" - переход на форму регистрации
- 🔘 Ссылка "Забыли пароль?" - восстановление пароля
- 🔘 Кнопки социальных сетей - OAuth авторизация

**API эндпоинты:**
```
POST /api/auth/login       - Вход
POST /api/auth/register    - Регистрация
POST /api/auth/reset       - Сброс пароля
GET  /api/auth/oauth/google - OAuth Google
```

---

### ЭТАП 2: ЛИЧНЫЙ КАБИНЕТ (DASHBOARD)

**Экран: Главная панель**

```
┌─────────────────────────────────────────────────────────────────┐
│  [☰] STAREC ADVOCAT          [🔔]  [👤 Иванов И.И.]  [Выход]   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  📊 МОИ ДЕЛА                                                    │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ [ + СОЗДАТЬ НОВОЕ ДЕЛО ]                                 │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  Активные дела (3):                                             │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │ 📁 Дело № 1234567                                       │    │
│  │    УД в отношении Петрова А.В. по ст. 159 УК РФ       │    │
│  │    Томов: 216 | Документов: 1,847 | Обработано: 98%   │    │
│  │    Последнее обновление: 18.01.2026                    │    │
│  │    [ Открыть дело ]  [ Продолжить анализ ]            │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │ 📁 Дело № 8765432                                       │    │
│  │    УД по ст. 228 УК РФ                                 │    │
│  │    Томов: 45 | Документов: 523 | Обработано: 100%     │    │
│  │    Последнее обновление: 15.01.2026                    │    │
│  │    [ Открыть дело ]  [ Экспорт стратегии ]            │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │ 📁 Дело № 2233445 (В ОБРАБОТКЕ)                        │    │
│  │    УД по ст. 210 УК РФ                                 │    │
│  │    Томов: 89 | Загружается том 12 из 89... [▓▓░░░] 25%│    │
│  │    [ Открыть дело ]  [ Приостановить ]                │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                  │
│  Архивные дела (12)  [ Показать архив ▼ ]                      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**Боковое меню (☰):**
```
┌──────────────────────┐
│ 📊 Мои дела          │
│ 📤 Загрузка томов    │
│ 📈 Статистика        │
│ ⚙️  Настройки        │
│ 📚 База знаний       │
│ 💬 Поддержка         │
│ 🚪 Выход             │
└──────────────────────┘
```

**Функции кнопок:**
- 🔘 "+ СОЗДАТЬ НОВОЕ ДЕЛО" - переход к созданию дела
- 🔘 "Открыть дело" - переход к просмотру дела
- 🔘 "Продолжить анализ" - продолжить с последнего этапа
- 🔘 "Экспорт стратегии" - скачать готовую стратегию защиты
- 🔘 "Приостановить" - остановить обработку
- 🔘 "Показать архив" - список завершенных дел

**API эндпоинты:**
```
GET  /api/cases                - Список дел пользователя
POST /api/cases                - Создать новое дело
GET  /api/cases/{id}           - Детали дела
PUT  /api/cases/{id}/archive   - Архивировать дело
```

---

### ЭТАП 3: СОЗДАНИЕ НОВОГО ДЕЛА

**Экран: Форма создания дела**

```
┌─────────────────────────────────────────────────────────────────┐
│  ← Назад к списку дел                                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  СОЗДАНИЕ НОВОГО ДЕЛА                                           │
│                                                                  │
│  Шаг 1 из 2: Основная информация                               │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  * Номер уголовного дела:                              │    │
│  │  [________________________________]                     │    │
│  │                                                         │    │
│  │  * Краткое описание:                                   │    │
│  │  [________________________________]                     │    │
│  │  (например: "УД в отношении Петрова по ст. 159 УК")  │    │
│  │                                                         │    │
│  │  Статья обвинения:                                     │    │
│  │  [________________________________]                     │    │
│  │                                                         │    │
│  │  Подсудимый (ФИО):                                     │    │
│  │  [________________________________]                     │    │
│  │                                                         │    │
│  │  Следственный орган:                                   │    │
│  │  [ СК РФ ▼ ]                                           │    │
│  │                                                         │    │
│  │  Дата возбуждения дела:                                │    │
│  │  [__|__/____]                                          │    │
│  │                                                         │    │
│  │  Примечания (опционально):                             │    │
│  │  [___________________________________________]         │    │
│  │  [___________________________________________]         │    │
│  │                                                         │    │
│  │  [ Отмена ]              [ Далее → ]                  │    │
│  └────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

**Функции:**
- 🔘 "Отмена" - вернуться к списку дел
- 🔘 "Далее" - перейти к загрузке томов
- ✏️ Автозаполнение статьи по номеру
- ✏️ Валидация обязательных полей

**API эндпоинты:**
```
POST /api/cases/create         - Создать дело (шаг 1)
GET  /api/references/articles  - Справочник статей УК РФ
GET  /api/references/organs    - Справочник следственных органов
```

---

### ЭТАП 4: ЗАГРУЗКА ТОМОВ ДЕЛА

**Экран: Подключение к Google Drive**

```
┌─────────────────────────────────────────────────────────────────┐
│  ← Назад                                                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ЗАГРУЗКА ТОМОВ ДЕЛА                                            │
│                                                                  │
│  Шаг 2 из 2: Источник томов                                    │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  Выберите способ загрузки томов:                       │    │
│  │                                                         │    │
│  │  ⚪ Из Google Drive                                    │    │
│  │  ⚪ Загрузить файлы с компьютера                       │    │
│  │  ⚪ Из облачного хранилища (Яндекс.Диск, Dropbox)     │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━      │
│                                                                  │
│  📂 GOOGLE DRIVE                                                │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  [ Подключить Google Drive ]                           │    │
│  │                                                         │    │
│  │  После подключения выберите папку с томами дела        │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                  │
│  Требования к файлам:                                           │
│  • Формат: PDF (отсканированные или текстовые)                 │
│  • Название файлов: "Том 001.pdf", "Том 002.pdf" и т.д.       │
│  • Максимальный размер одного тома: 500 МБ                     │
│  • Поддерживается OCR для отсканированных документов           │
│                                                                  │
│  [ Отмена ]              [ Подключить Google Drive ]           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**После подключения Google Drive:**

```
┌─────────────────────────────────────────────────────────────────┐
│  ВЫБОР ПАПКИ С ТОМАМИ                                           │
│                                                                  │
│  🔗 Google Drive подключен: user@gmail.com                      │
│                                                                  │
│  Выберите папку с томами дела:                                 │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  📁 Мой диск                                   ▼       │    │
│  │    📁 Дела                                              │    │
│  │      📁 Дело № 1234567 ✓ (выбрано)                    │    │
│  │        📄 Том 001.pdf (125 МБ)                         │    │
│  │        📄 Том 002.pdf (98 МБ)                          │    │
│  │        📄 Том 003.pdf (156 МБ)                         │    │
│  │        ... (всего 216 файлов)                          │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                  │
│  📊 Обнаружено томов: 216                                       │
│  📊 Общий размер: 28.4 ГБ                                       │
│  ⏱️  Примерное время обработки: 6-8 часов                       │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  Настройки обработки:                                  │    │
│  │                                                         │    │
│  │  ☑ Применить OCR к отсканированным страницам          │    │
│  │  ☑ Автоматически выделять документы                   │    │
│  │  ☑ Распознавать участников и даты                     │    │
│  │  ☑ Создавать preview для быстрого просмотра           │    │
│  │                                                         │    │
│  │  Приоритет обработки: [ Средний ▼ ]                   │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                  │
│  [ Назад ]        [ Начать загрузку и обработку ]              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**Функции:**
- 🔘 "Подключить Google Drive" - OAuth авторизация
- 🔘 "Выбор папки" - браузер файлов Google Drive
- 🔘 "Начать загрузку" - запуск процесса обработки
- ☑️ Чекбоксы настроек обработки
- 📊 Автоматический подсчет томов и размера

**API эндпоинты:**
```
GET  /api/integrations/gdrive/auth      - OAuth для Google Drive
GET  /api/integrations/gdrive/folders   - Список папок
POST /api/integrations/gdrive/sync      - Начать синхронизацию
GET  /api/cases/{id}/volumes/status     - Статус загрузки томов
```

---

### ЭТАП 5: ПРОЦЕСС ОБРАБОТКИ ТОМОВ

**Экран: Мониторинг обработки**

```
┌─────────────────────────────────────────────────────────────────┐
│  ОБРАБОТКА ТОМОВ ДЕЛА № 1234567                                 │
│                                                                  │
│  Общий прогресс: [▓▓▓▓▓▓▓▓▓░░░░░░░░░] 58% (125 из 216 томов)  │
│                                                                  │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━      │
│                                                                  │
│  📥 ЗАГРУЗКА                                                    │
│  ✅ Загружено: 216 томов (28.4 ГБ)                             │
│  ⏱️  Время: 42 мин                                              │
│                                                                  │
│  🔍 OCR И РАСПОЗНАВАНИЕ                                         │
│  ▓▓▓▓▓▓▓▓▓░░░░░░░░░ 58% (125/216)                              │
│  ⏱️  Осталось: ~3.5 часа                                        │
│  Текущий том: Том 125.pdf (страница 456 из 623)               │
│                                                                  │
│  📄 ВЫДЕЛЕНИЕ ДОКУМЕНТОВ                                        │
│  ▓▓▓▓▓▓░░░░░░░░░░░░ 42% (91/216)                               │
│  Найдено документов: 1,247                                      │
│                                                                  │
│  🧠 AI АНАЛИЗ СТРУКТУРЫ                                         │
│  ▓▓▓▓░░░░░░░░░░░░░░ 28% (60/216)                               │
│  Определены типы документов: 823                                │
│                                                                  │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━      │
│                                                                  │
│  📊 СТАТИСТИКА                                                  │
│  • Страниц обработано: 78,456                                  │
│  • Символов распознано: 45.2 млн                               │
│  • Ошибок OCR: 23 (проверка требуется)                        │
│  • Среднее качество распознавания: 98.7%                       │
│                                                                  │
│  [ Приостановить ]  [ Отменить ]  [ Свернуть в фон ]          │
│                                                                  │
│  💡 Вы можете закрыть эту страницу - обработка продолжится     │
│     в фоновом режиме. Уведомим вас по email о завершении.      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**Функции:**
- 📊 Реал-тайм обновление прогресса (WebSocket)
- 🔘 "Приостановить" - пауза обработки
- 🔘 "Отменить" - отмена и удаление
- 🔘 "Свернуть в фон" - продолжить в фоне
- 📧 Email уведомления о завершении
- ⚠️ Предупреждения об ошибках OCR

**API эндпоинты:**
```
GET  /api/cases/{id}/processing/status  - Статус обработки
POST /api/cases/{id}/processing/pause   - Приостановить
POST /api/cases/{id}/processing/cancel  - Отменить
WS   /ws/cases/{id}/processing          - WebSocket для реал-тайм обновлений
```

---

## 3. ДЕТАЛИЗАЦИЯ СЛЕДУЮЩИХ ЭТАПОВ

Продолжить с детальным описанием:
- Этап 6: Просмотр структуры дела и томов
- Этап 7: Работа с отдельными документами
- Этап 8: Запуск анализа документа/дела
- Этап 9: Просмотр результатов анализа
- Этап 10: Формирование стратегии защиты
- Этап 11: Экспорт и работа с результатами

**Статус:** Документ создан, продолжение следует...

# Starec-Advocat 2.0 - Финальные этапы и технический стек

**Дата создания:** 19 января 2026

---

## ЭТАП 10: АНАЛИЗ ВСЕГО ДЕЛА

**Экран: Вкладка "Анализ дела"**

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  ДЕЛО № 1234567 - КОМПЛЕКСНЫЙ АНАЛИЗ                                        │
│                                                                              │
│  [ 📊 Обзор ] [ 📚 Тома ] [ 📄 Документы ] [ 🔍 Анализ ] [ 📋 Стратегия ]   │
│                                                                              │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│                                                                              │
│  🔍 ЗАПУСК ПОЛНОГО АНАЛИЗА ДЕЛА                                             │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │  Выберите модули анализа:                                        │       │
│  │                                                                   │       │
│  │  ☑ Процессуальный анализ                                         │       │
│  │     • Соблюдение сроков и процедур                              │       │
│  │     • Допустимость доказательств                                │       │
│  │     • Процессуальные нарушения                                  │       │
│  │                                                                   │       │
│  │  ☑ Анализ доказательств                                          │       │
│  │     • Классификация по юридическому весу                        │       │
│  │     • Выявление противоречий                                    │       │
│  │     • Оценка достоверности и относимости                        │       │
│  │                                                                   │       │
│  │  ☑ Анализ квалификации                                           │       │
│  │     • Соответствие фактов составу преступления                  │       │
│  │     • Альтернативные квалификации                               │       │
│  │     • Смягчающие и отягчающие обстоятельства                   │       │
│  │                                                                   │       │
│  │  ☑ Анализ участников                                             │       │
│  │     • Профили всех участников                                   │       │
│  │     • Противоречия в показаниях                                 │       │
│  │     • Заинтересованность и мотивация                           │       │
│  │                                                                   │       │
│  │  ☑ Хронологический анализ                                        │       │
│  │     • Временная шкала событий                                   │       │
│  │     • Несоответствия по датам                                   │       │
│  │     • Невозможность событий в указанные сроки                  │       │
│  │                                                                   │       │
│  │  ☑ Поиск судебной практики                                       │       │
│  │     • Релевантные решения ВС РФ                                 │       │
│  │     • Постановления КС РФ                                       │       │
│  │     • Обзоры судебной практики                                  │       │
│  │                                                                   │       │
│  │  ☑ Формирование линий защиты                                     │       │
│  │     • Основные аргументы защиты                                 │       │
│  │     • Альтернативные сценарии                                   │       │
│  │     • Тактический план                                          │       │
│  └─────────────────────────────────────────────────────────────────┘       │
│                                                                              │
│  Глубина анализа:  ⚪ Быстрый (1-2 часа)                                    │
│                    🔘 Стандартный (4-6 часов)                               │
│                    ⚪ Углубленный (8-12 часов)                              │
│                                                                              │
│  AI модель:        [ Claude Opus 4.5 (рекомендуется) ▼ ]                   │
│                                                                              │
│  Примерная стоимость: ~2,500 ₽ (API calls)                                  │
│  Время завершения: ~6 часов                                                 │
│                                                                              │
│  [ Отмена ]                    [ 🚀 Начать анализ ]                         │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

**Во время анализа:**

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  АНАЛИЗ ДЕЛА В ПРОЦЕССЕ...                                                  │
│                                                                              │
│  Общий прогресс: [▓▓▓▓▓▓▓░░░░░░░░░] 45%  ⏱️  Осталось: ~3 часа 20 мин     │
│                                                                              │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│                                                                              │
│  ✅ Процессуальный анализ         [▓▓▓▓▓▓▓▓▓▓] 100%  (завершен)            │
│     → Найдено 12 процессуальных нарушений                                  │
│                                                                              │
│  ⏳ Анализ доказательств          [▓▓▓▓▓▓░░░░] 60%  (в процессе)           │
│     → Обработано 1,108 из 1,847 документов                                 │
│     → Выявлено 23 противоречия в показаниях                                │
│                                                                              │
│  ⏸️  Анализ квалификации          [░░░░░░░░░░] 0%   (ожидание)             │
│                                                                              │
│  ⏸️  Анализ участников            [░░░░░░░░░░] 0%   (ожидание)             │
│                                                                              │
│  ⏸️  Хронологический анализ       [░░░░░░░░░░] 0%   (ожидание)             │
│                                                                              │
│  ⏸️  Поиск судебной практики      [░░░░░░░░░░] 0%   (ожидание)             │
│                                                                              │
│  ⏸️  Формирование линий защиты    [░░░░░░░░░░] 0%   (ожидание)             │
│                                                                              │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│                                                                              │
│  🤖 Текущая операция:                                                       │
│  Анализ протокола допроса свидетеля Иванова И.И. на предмет                │
│  противоречий с показаниями Петрова А.В...                                 │
│                                                                              │
│  📊 Статистика:                                                             │
│  • Обработано токенов: 12.4 млн                                            │
│  • Вызовов API: 847                                                        │
│  • Стоимость на данный момент: ₽1,125                                      │
│                                                                              │
│  [ Приостановить ]  [ Отменить ]  [ Свернуть в фон ]                       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## ЭТАП 11: ФОРМИРОВАНИЕ СТРАТЕГИИ ЗАЩИТЫ

**Экран: Вкладка "Стратегия"**

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  СТРАТЕГИЯ ЗАЩИТЫ - ДЕЛО № 1234567                                          │
│                                                                              │
│  [ 📊 Обзор ] [ 📚 Тома ] [ 📄 Документы ] [ 🔍 Анализ ] [ 📋 Стратегия ]   │
│                                                                              │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│                                                                              │
│  📋 СТРАТЕГИЯ ЗАЩИТЫ                                                        │
│  Сформирована: 19.01.2026 18:45 | AI: Claude Opus 4.5 | Версия: 1.2        │
│                                                                              │
│  [ 📥 Экспорт DOCX ]  [ 📧 Отправить ]  [ 🖨️ Печать ]  [ 🔄 Обновить ]     │
│                                                                              │
│  ┌─── СОДЕРЖАНИЕ ────────────────────────────────────────────┐             │
│  │  1. Резюме стратегии защиты                                │             │
│  │  2. Введение (описание дела)                               │             │
│  │  3. Процессуальный анализ                                  │             │
│  │     3.1. Нарушения сроков                                  │             │
│  │     3.2. Нарушения процедуры                               │             │
│  │     3.3. Недопустимые доказательства                       │             │
│  │  4. Анализ доказательств обвинения                         │             │
│  │     4.1. Показания свидетелей                              │             │
│  │     4.2. Экспертизы                                        │             │
│  │     4.3. Вещественные доказательства                       │             │
│  │  5. Анализ квалификации                                    │             │
│  │  6. Основные линии защиты                                  │             │
│  │  7. Альтернативные сценарии                                │             │
│  │  8. Судебная практика                                      │             │
│  │  9. Тактический план                                       │             │
│  │  10. Приложения                                            │             │
│  └────────────────────────────────────────────────────────────┘             │
│                                                                              │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│                                                                              │
│  📝 1. РЕЗЮМЕ СТРАТЕГИИ ЗАЩИТЫ                                              │
│                                                                              │
│  По результатам комплексного анализа уголовного дела № 1234567              │
│  выявлено 12 существенных процессуальных нарушений, 23 противоречия        │
│  в доказательствах обвинения и 3 недопустимых доказательства.              │
│                                                                              │
│  Рекомендуемая стратегия защиты состоит из трех основных линий:            │
│                                                                              │
│  ⭐ ОСНОВНАЯ ЛИНИЯ: Оспаривание допустимости доказательств                  │
│  Вероятность успеха: ВЫСОКАЯ (65-80%)                                       │
│  [Подробнее ▼]                                                              │
│                                                                              │
│  ⭐⭐ ДОПОЛНИТЕЛЬНАЯ ЛИНИЯ: Переквалификация на ст. 165 УК РФ               │
│  Вероятность успеха: СРЕДНЯЯ (40-55%)                                       │
│  [Подробнее ▼]                                                              │
│                                                                              │
│  ⭐⭐⭐ РЕЗЕРВНАЯ ЛИНИЯ: Смягчающие обстоятельства                           │
│  Вероятность успеха: ВЫСОКАЯ (75-90%)                                       │
│  [Подробнее ▼]                                                              │
│                                                                              │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│                                                                              │
│  ⚖️  3. ПРОЦЕССУАЛЬНЫЕ НАРУШЕНИЯ (12)                                       │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │  ⚠️  КРИТИЧЕСКОЕ НАРУШЕНИЕ #1                                    │       │
│  │  Превышение срока рассмотрения материала проверки                │       │
│  │  ───────────────────────────────────────────────────────────     │       │
│  │  Норма: ч. 1 ст. 144 УПК РФ                                     │       │
│  │  Документ: Постановление о возбуждении УД (Том 1, л. 1-8)       │       │
│  │  Дата обнаружения: 19.01.2026                                    │       │
│  │                                                                   │       │
│  │  Описание:                                                        │       │
│  │  Материал проверки зарегистрирован 10.03.2024, постановление     │       │
│  │  вынесено 15.03.2024 (5 суток вместо 3). Продление срока не     │       │
│  │  оформлено.                                                       │       │
│  │                                                                   │       │
│  │  Судебная практика:                                               │       │
│  │  • Определение ВС РФ № 127-УД22-8 от 15.11.2022                 │       │
│  │  • Постановление КС РФ № 23-П от 02.07.2013                     │       │
│  │  [Показать тексты →]                                             │       │
│  │                                                                   │       │
│  │  Рекомендуемые действия:                                          │       │
│  │  1. Жалоба в порядке ст. 125 УПК РФ на действия следователя     │       │
│  │  2. Ходатайство о признании постановления о возбуждении УД       │       │
│  │     незаконным                                                    │       │
│  │  3. При отказе - кассационная жалоба                             │       │
│  │                                                                   │       │
│  │  Шаблоны документов:                                              │       │
│  │  [ 📄 Жалоба по ст. 125 УПК ]  [ 📄 Ходатайство ]               │       │
│  │                                                                   │       │
│  │  Срок подачи: До начала судебного следствия                      │       │
│  │  Приоритет: ⭐⭐⭐ ВЫСОКИЙ                                         │       │
│  │  Вероятность успеха: 55-70%                                      │       │
│  │                                                                   │       │
│  │  [ ✓ Включить в тактический план ]  [ 📧 Отправить адвокату ]   │       │
│  └─────────────────────────────────────────────────────────────────┘       │
│                                                                              │
│  [Показать все 12 нарушений ▼]                                              │
│                                                                              │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│                                                                              │
│  🎯 6. ОСНОВНЫЕ ЛИНИИ ЗАЩИТЫ                                                │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │  ⭐⭐⭐ ЛИНИЯ ЗАЩИТЫ #1: Недопустимость ключевых доказательств   │       │
│  │  Вероятность успеха: ВЫСОКАЯ (65-80%)                            │       │
│  │  ───────────────────────────────────────────────────────────     │       │
│  │                                                                   │       │
│  │  Суть аргумента:                                                  │       │
│  │  Ключевые доказательства обвинения (протоколы обыска, показания │       │
│  │  свидетеля Иванова, заключение эксперта) получены с              │       │
│  │  нарушением УПК РФ и должны быть признаны недопустимыми.        │       │
│  │                                                                   │       │
│  │  Подтверждающие документы:                                        │       │
│  │  • Протокол обыска от 20.03.2024 (Том 5, л. 123-130)            │       │
│  │    → Нарушение: отсутствует понятой                             │       │
│  │  • Протокол допроса Иванова (Том 1, л. 45-52)                   │       │
│  │    → Нарушение: не разъяснена ст. 51 Конституции РФ             │       │
│  │  • Заключение эксперта № 456 (Том 12, л. 89-102)                │       │
│  │    → Нарушение: эксперт не предупрежден об ответственности      │       │
│  │                                                                   │       │
│  │  Судебная практика (8 решений):                                   │       │
│  │  • Постановление Пленума ВС РФ № 55 от 19.12.2017 (п. 5-7)     │       │
│  │  • Определение ВС РФ № 4-УД19-32 от 15.05.2019                  │       │
│  │  • Кассационное определение ВС РФ № 45-УД21-18 от 12.08.2021   │       │
│  │  [Показать все →]                                                 │       │
│  │                                                                   │       │
│  │  Тактический план:                                                │       │
│  │  1. На стадии предварительного слушания:                         │       │
│  │     → Ходатайство об исключении протокола обыска                 │       │
│  │     → Ходатайство об исключении показаний Иванова               │       │
│  │  2. При отказе:                                                   │       │
│  │     → Апелляция на промежуточное решение                         │       │
│  │  3. На судебном следствии:                                        │       │
│  │     → Допрос понятых по обыску (выявить противоречия)           │       │
│  │     → Повторный допрос свидетеля Иванова                        │       │
│  │                                                                   │       │
│  │  Документы для подготовки:                                        │       │
│  │  [ 📄 Ходатайство об исключении доказательств ]                  │       │
│  │  [ 📄 Апелляция на отказ ]                                       │       │
│  │  [ 📄 Вопросы для допроса понятых ]                              │       │
│  │                                                                   │       │
│  │  Риски:                                                           │       │
│  │  ⚠️  Возможно частичное удовлетворение (исключение только части) │       │
│  │  ⚠️  Следствие может представить дополнительные доказательства   │       │
│  │                                                                   │       │
│  │  Прогноз:                                                         │       │
│  │  При успешной реализации - снятие обвинения или переквалификация │       │
│  │  на менее тяжкое преступление.                                   │       │
│  │                                                                   │       │
│  │  [ ✓ Утвердить как основную линию ]  [ 📧 Отправить адвокату ]  │       │
│  └─────────────────────────────────────────────────────────────────┘       │
│                                                                              │
│  [Показать все 3 линии защиты ▼]                                            │
│                                                                              │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│                                                                              │
│  📅 9. ТАКТИЧЕСКИЙ ПЛАН (КАЛЕНДАРЬ)                                         │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │  📌 ЭТАП 1: Досудебное производство (текущий этап)              │       │
│  │  Срок: 20.01.2026 - 15.03.2026                                   │       │
│  │                                                                   │       │
│  │  ☐  22.01.2026 - Жалоба по ст. 125 УПК (нарушение сроков)      │       │
│  │  ☐  29.01.2026 - Ходатайство о допросе свидетелей защиты        │       │
│  │  ☐  05.02.2026 - Ходатайство о назначении повторной экспертизы  │       │
│  │  ☐  15.02.2026 - Ознакомление с материалами дела (начало)       │       │
│  │  ☐  01.03.2026 - Ознакомление завершено                         │       │
│  │  ☐  10.03.2026 - Возражения на обвинительное заключение         │       │
│  │                                                                   │       │
│  │  [ Добавить задачу ]  [ Экспорт в календарь ]                    │       │
│  └─────────────────────────────────────────────────────────────────┘       │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │  📌 ЭТАП 2: Предварительное слушание                             │       │
│  │  Срок: 20.03.2026 - 15.04.2026 (ориентировочно)                 │       │
│  │                                                                   │       │
│  │  ☐  Ходатайство об исключении недопустимых доказательств        │       │
│  │  ☐  Ходатайство о возвращении дела прокурору                    │       │
│  │  ☐  Ходатайство о прекращении дела (при наличии оснований)      │       │
│  │                                                                   │       │
│  │  [ Добавить задачу ]                                              │       │
│  └─────────────────────────────────────────────────────────────────┘       │
│                                                                              │
│  [Показать все 5 этапов ▼]                                                  │
│                                                                              │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│                                                                              │
│  ДЕЙСТВИЯ:                                                                   │
│  [ 📥 Скачать полную стратегию (DOCX) ]                                     │
│  [ 📧 Отправить по email ]                                                   │
│  [ 🖨️ Распечатать ]                                                          │
│  [ 🔄 Обновить стратегию ]                                                   │
│  [ 📊 Экспорт в Excel (тактический план) ]                                  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. ТЕХНИЧЕСКИЙ СТЕК И АРХИТЕКТУРА

### 4.1. FRONTEND

**Технологии:**
```
React 18.2+              - UI библиотека
TypeScript 5.0+          - Типизация
Vite 5.0+                - Сборщик
React Router 6.0+        - Роутинг
TanStack Query (React Query) - Управление состоянием сервера
Zustand                  - Локальное состояние
Tailwind CSS 3.0+        - Стили
shadcn/ui                - UI компоненты
React Hook Form          - Формы
Zod                      - Валидация
Recharts                 - Графики
React PDF                - Просмотр PDF
React Virtuoso           - Виртуализация списков
Socket.IO Client         - WebSocket
```

**Структура проекта:**
```
frontend/
├── src/
│   ├── components/
│   │   ├── auth/           - Компоненты авторизации
│   │   ├── dashboard/      - Дашборд
│   │   ├── cases/          - Работа с делами
│   │   ├── documents/      - Документы
│   │   ├── analysis/       - Анализ
│   │   ├── strategy/       - Стратегия
│   │   └── ui/             - UI компоненты (shadcn)
│   ├── pages/              - Страницы
│   ├── hooks/              - Custom hooks
│   ├── lib/                - Утилиты
│   ├── api/                - API клиент
│   ├── stores/             - Zustand stores
│   └── types/              - TypeScript типы
├── public/
├── package.json
└── vite.config.ts
```

### 4.2. BACKEND API

**Технологии:**
```
FastAPI 0.104+           - Web фреймворк
Python 3.11+             - Язык программирования
Pydantic 2.0+            - Валидация данных
SQLAlchemy 2.0+          - ORM
Alembic                  - Миграции БД
Celery 5.3+              - Очереди задач
Redis 7.0+               - Кеш и брокер сообщений
JWT                      - Аутентификация
Anthropic SDK            - Claude API
OpenAI SDK               - OpenAI API (резерв)
PyMuPDF (fitz)           - Обработка PDF
Tesseract OCR            - Распознавание текста
spaCy                    - NLP (извлечение сущностей)
LangChain                - AI цепочки
```

**Структура проекта:**
```
backend/
├── app/
│   ├── api/
│   │   ├── auth.py         - Аутентификация
│   │   ├── cases.py        - API дел
│   │   ├── documents.py    - API документов
│   │   ├── analysis.py     - API анализа
│   │   ├── strategy.py     - API стратегии
│   │   └── integrations.py - Интеграции (Google Drive)
│   ├── core/
│   │   ├── config.py       - Конфигурация
│   │   ├── security.py     - Безопасность
│   │   └── dependencies.py - Зависимости
│   ├── models/             - SQLAlchemy модели
│   ├── schemas/            - Pydantic схемы
│   ├── services/           - Бизнес-логика
│   │   ├── auth_service.py
│   │   ├── case_service.py
│   │   ├── document_service.py
│   │   ├── ocr_service.py
│   │   ├── analysis_service.py
│   │   └── strategy_service.py
│   ├── workers/            - Celery tasks
│   │   ├── ocr_tasks.py
│   │   ├── analysis_tasks.py
│   │   └── gdrive_tasks.py
│   └── main.py             - Точка входа
├── migrations/             - Alembic миграции
├── requirements.txt
└── Dockerfile
```

**API эндпоинты (краткий список):**
```
POST   /api/auth/register              - Регистрация
POST   /api/auth/login                 - Вход
POST   /api/auth/refresh               - Обновление токена
GET    /api/auth/me                    - Текущий пользователь

GET    /api/cases                      - Список дел
POST   /api/cases                      - Создать дело
GET    /api/cases/{id}                 - Детали дела
PUT    /api/cases/{id}                 - Обновить дело
DELETE /api/cases/{id}                 - Удалить дело

GET    /api/cases/{id}/volumes         - Тома дела
POST   /api/cases/{id}/volumes/sync    - Синхронизация с GDrive
GET    /api/cases/{id}/volumes/{vol_id} - Детали тома

GET    /api/cases/{id}/documents       - Документы дела
GET    /api/documents/{id}             - Детали документа
POST   /api/documents/{id}/analyze     - Анализ документа
GET    /api/documents/{id}/entities    - Сущности документа
GET    /api/documents/{id}/connections - Связи документа

POST   /api/cases/{id}/analysis/start  - Начать анализ дела
GET    /api/cases/{id}/analysis/status - Статус анализа
GET    /api/cases/{id}/analysis/results - Результаты анализа

GET    /api/cases/{id}/strategy        - Стратегия защиты
POST   /api/cases/{id}/strategy/generate - Сгенерировать стратегию
GET    /api/cases/{id}/strategy/export - Экспорт стратегии

WS     /ws/cases/{id}/processing       - WebSocket для реал-тайм обновлений
```

### 4.3. БАЗЫ ДАННЫХ

**PostgreSQL (Основная БД)**
```sql
-- Пользователи
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    hashed_password VARCHAR(255) NOT NULL,
    full_name VARCHAR(255),
    created_at TIMESTAMP DEFAULT NOW(),
    is_active BOOLEAN DEFAULT TRUE
);

-- Дела
CREATE TABLE cases (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    case_number VARCHAR(100) NOT NULL,
    title VARCHAR(500) NOT NULL,
    article VARCHAR(100),
    defendant_name VARCHAR(255),
    investigative_body VARCHAR(255),
    initiation_date DATE,
    status VARCHAR(50) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Тома
CREATE TABLE volumes (
    id SERIAL PRIMARY KEY,
    case_id INTEGER REFERENCES cases(id),
    volume_number INTEGER NOT NULL,
    gdrive_file_id VARCHAR(255),
    file_name VARCHAR(500),
    file_size BIGINT,
    page_count INTEGER,
    ocr_quality FLOAT,
    processing_status VARCHAR(50),
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(case_id, volume_number)
);

-- Документы
CREATE TABLE documents (
    id SERIAL PRIMARY KEY,
    case_id INTEGER REFERENCES cases(id),
    volume_id INTEGER REFERENCES volumes(id),
    doc_type VARCHAR(100),
    title VARCHAR(1000),
    start_page INTEGER,
    end_page INTEGER,
    document_date DATE,
    author VARCHAR(255),
    importance_score INTEGER,
    analysis_status VARCHAR(50),
    full_text TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Сущности (участники, даты, суммы и т.д.)
CREATE TABLE entities (
    id SERIAL PRIMARY KEY,
    document_id INTEGER REFERENCES documents(id),
    entity_type VARCHAR(50),  -- person, date, amount, article
    entity_value TEXT,
    context TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Анализ документов
CREATE TABLE document_analyses (
    id SERIAL PRIMARY KEY,
    document_id INTEGER REFERENCES documents(id),
    analysis_type VARCHAR(50),  -- procedural, evidence, etc
    findings JSONB,
    violations JSONB,
    recommendations JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Анализ дел
CREATE TABLE case_analyses (
    id SERIAL PRIMARY KEY,
    case_id INTEGER REFERENCES cases(id),
    analysis_status VARCHAR(50),
    progress INTEGER DEFAULT 0,
    findings JSONB,
    violations JSONB[],
    defense_lines JSONB[],
    created_at TIMESTAMP DEFAULT NOW(),
    completed_at TIMESTAMP
);

-- Стратегии защиты
CREATE TABLE defense_strategies (
    id SERIAL PRIMARY KEY,
    case_id INTEGER REFERENCES cases(id),
    version INTEGER DEFAULT 1,
    content JSONB,  -- полная структура стратегии
    generated_at TIMESTAMP DEFAULT NOW()
);
```

**MongoDB (Документы и файлы)**
```javascript
// Коллекция: processed_volumes
{
  _id: ObjectId,
  case_id: Integer,
  volume_id: Integer,
  pages: [
    {
      page_number: Integer,
      ocr_text: String,
      ocr_confidence: Float,
      image_url: String,
      entities: []
    }
  ],
  metadata: {},
  created_at: ISODate
}

// Коллекция: ai_analysis_cache
{
  _id: ObjectId,
  document_id: Integer,
  prompt_hash: String,
  model: String,
  response: {},
  tokens_used: Integer,
  created_at: ISODate,
  expires_at: ISODate
}
```

**Redis (Кеш и очереди)**
```
# Кеш анализа
cache:document:{id}:analysis     - Результат анализа документа
cache:case:{id}:summary          - Сводка по делу
cache:user:{id}:cases            - Список дел пользователя

# Celery очереди
celery:ocr:queue                 - Очередь OCR задач
celery:analysis:queue            - Очередь анализа
celery:strategy:queue            - Очередь формирования стратегии

# WebSocket sessions
ws:case:{id}:viewers             - Активные пользователи
ws:processing:{task_id}          - Статусы обработки
```

### 4.4. CELERY WORKERS

**Воркеры:**
```
worker_ocr (3 экземпляра)      - OCR обработка
worker_analysis (2 экземпляра) - AI анализ
worker_gdrive (1 экземпляр)    - Синхронизация с Google Drive
```

**Задачи:**
```python
# workers/ocr_tasks.py
@celery_app.task
def process_volume_ocr(volume_id: int):
    """OCR обработка тома"""
    pass

@celery_app.task
def extract_documents_from_volume(volume_id: int):
    """Выделение документов из тома"""
    pass

# workers/analysis_tasks.py
@celery_app.task
def analyze_document(document_id: int):
    """Анализ отдельного документа"""
    pass

@celery_app.task
def analyze_case_full(case_id: int):
    """Полный анализ дела"""
    pass

@celery_app.task
def generate_defense_strategy(case_id: int):
    """Формирование стратегии защиты"""
    pass

# workers/gdrive_tasks.py
@celery_app.task
def sync_gdrive_folder(case_id: int, folder_id: str):
    """Синхронизация папки с Google Drive"""
    pass
```

---

## 5. DEPLOYMENT (HETZNER SERVER)

**Docker Compose структура:**
```yaml
version: '3.8'

services:
  # Frontend (React + Nginx)
  frontend:
    build: ./frontend
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/ssl
    depends_on:
      - backend

  # Backend API (FastAPI)
  backend:
    build: ./backend
    ports:
      - "8083:8000"
    environment:
      - DATABASE_URL=postgresql://user:pass@postgres:5432/starec_advocat
      - MONGODB_URL=mongodb://mongo:27017/starec_advocat
      - REDIS_URL=redis://redis:6379/0
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    depends_on:
      - postgres
      - mongo
      - redis

  # Celery Workers
  celery_ocr:
    build: ./backend
    command: celery -A app.workers worker -Q ocr -c 3 -n ocr@%h
    environment:
      - DATABASE_URL=postgresql://user:pass@postgres:5432/starec_advocat
      - MONGODB_URL=mongodb://mongo:27017/starec_advocat
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - postgres
      - mongo
      - redis

  celery_analysis:
    build: ./backend
    command: celery -A app.workers worker -Q analysis -c 2 -n analysis@%h
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    depends_on:
      - postgres
      - mongo
      - redis

  # Celery Beat (планировщик)
  celery_beat:
    build: ./backend
    command: celery -A app.workers beat
    depends_on:
      - redis

  # PostgreSQL
  postgres:
    image: postgres:16
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_USER=starec_user
      - POSTGRES_PASSWORD=starec_pass
      - POSTGRES_DB=starec_advocat
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # MongoDB
  mongo:
    image: mongo:7
    ports:
      - "27018:27017"
    volumes:
      - mongo_data:/data/db

  # Redis
  redis:
    image: redis:7-alpine
    ports:
      - "6380:6379"
    volumes:
      - redis_data:/data

  # Flower (мониторинг Celery)
  flower:
    build: ./backend
    command: celery -A app.workers flower --port=5555
    ports:
      - "5555:5555"
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
    depends_on:
      - redis

volumes:
  postgres_data:
  mongo_data:
  redis_data:
```

**Команды развертывания:**
```bash
# На сервере Hetzner
ssh root@136.243.71.213

cd /opt/starec-advocat

# Создать структуру
mkdir -p {frontend,backend,nginx,data}

# Склонировать репозиторий
git clone <repo_url> .

# Создать .env файл
cat > .env << EOF
ANTHROPIC_API_KEY=sk-...
OPENAI_API_KEY=sk-...
POSTGRES_PASSWORD=...
GOOGLE_OAUTH_CLIENT_ID=...
GOOGLE_OAUTH_CLIENT_SECRET=...
EOF

# Запустить
docker-compose up -d

# Проверить статус
docker-compose ps
docker-compose logs -f
```

---

Это завершающая часть архитектуры. Все три файла вместе составляют полную детальную документацию проекта.
